from django.utils.crypto import get_random_string
from django.conf import settings
from django.contrib import messages
from django.shortcuts import render, get_object_or_404, redirect
from cart.models import Order, Cart
from .models import ShippingForm, ShippingAddress
from django.views.generic.base import TemplateView



def checkout(request):
    # Checkout view
    form = ShippingForm

    order_qs = Order.objects.filter(user=request.user, ordered=False)
    order_items = order_qs[0].orderitems.all()
    order_total = order_qs[0].get_totals()
    context = {"form": form, "order_items": order_items, "order_total": order_total}
    # Getting the saved saved_address
    saved_address = ShippingAddress.objects.filter(user=request.user)
    if saved_address.exists():
        savedAddress = saved_address.first()
        context = {"form": form, "order_items": order_items, "order_total": order_total, "savedAddress": savedAddress}
    if request.method == "POST":
        saved_address = ShippingAddress.objects.filter(user=request.user)
        if saved_address.exists():

            savedAddress = saved_address.first()
            form = ShippingForm(request.POST, instance=savedAddress)
            if form.is_valid():
                shippingaddress = form.save(commit=False)
                shippingaddress.user = request.user
                shippingaddress.save()
        else:
            form = ShippingForm(request.POST)
            if form.is_valid():
                shippingaddress = form.save(commit=False)
                shippingaddress.user = request.user
                shippingaddress.save()

    return render(request, 'checkout/index.html', context)


def payment(request):
    key = settings.STRIPE_PUBLISHABLE_KEY
    order_qs = Order.objects.filter(user=request.user, ordered=False)
    order_total = order_qs[0].get_totals()
    totalCents = float(order_total * 100);
    total = round(totalCents, 2)
    if request.method == 'POST':
        charge = stripe.Charge.create(amount=total,
                                      currency='usd',
                                      description=order_qs,
                                      source=request.POST['stripeToken'])
        print(charge)

    return render(request, 'checkout/payment.html', {"key": key, "total": total})


def charge(request):
    order = Order.objects.get(user=request.user, ordered=False)
    orderitems = order.orderitems.all()
    order_total = order.get_totals()
    totalCents = int(float(order_total * 100))
    if request.method == 'POST':
        charge = stripe.Charge.create(amount=totalCents,
                                      currency='inr',
                                      description=order,
                                      source=request.POST['stripeToken'])
        print(charge)
        if charge.status == "succeeded":
            orderId = get_random_string(length=16,
                                        allowed_chars=u'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789')
            print(charge.id)
            order.ordered = True
            order.paymentId = charge.id
            order.orderId = f'#{request.user}{orderId}'
            order.save()
            cartItems = Cart.objects.filter(user=request.user)
            for item in cartItems:
                item.purchased = True
                item.save()
        return render(request, 'checkout/charge.html', {"items": orderitems, "order": order})


def oderView(request):
    orders = Order.objects.filter(user=request.user, ordered=True)
    if orders.exists():
        return render(request, 'checkout/order.html', {'orders': orders})
    else:
        messages.warning(request, "You do not have an active order")
        return redirect('/')

    # try:
    #     orders = Order.objects.filter(user=request.user, ordered=False)
    #     context = {"orders": orders}
    # except:
    #     messages.warning(request, "You do not have an active order")
    #     return redirect('/')
    # return render(request, 'checkout/order.html', context)
